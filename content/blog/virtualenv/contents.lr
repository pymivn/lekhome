title:

ƒê·ª´ng sudo, n·∫øu kh√¥ng bi·∫øt virtualenv
---
author: HVN
---
pub_date: 2017-07-06
---
shortintro: N·∫øu b·∫°n g√µ `sudo pip` ƒë·ªÉ c√†i Python package, c√≥ th·ªÉ b·∫°n ƒë√£ sai
---
body:

- "M√¨nh kh√¥ng c√†i b·∫±ng pip ƒë∆∞·ª£c..."
- "ch·∫°y sudo pip ... nh√© "

ƒê√≥ l√† nh·ªØng c√¢u h·ªèi v√† tr·∫£ l·ªùi th∆∞·ªùng xu·∫•t hi·ªán, khi ng∆∞·ªùi ta n√≥i v·ªÅ pip. ƒê√¢y l√† v·∫•n ƒë·ªÅ chung v·ªõi nh·ªØng ng∆∞·ªùi d√πng kh√¥ng hi·ªÉu v·ªÅ ph√¢n quy·ªÅn tr√™n UNIX v√† th∆∞·ªùng s·∫Ω l√†m m·ªçi th·ª© tr·ªü n√™n r·∫Øc r·ªëi th√™m b·∫±ng c√°ch ch·∫°y sudo.

## sudo - c√¢u l·ªánh th·∫ßn th√°nh

![Sudo XKCD](https://imgs.xkcd.com/comics/sandwich.png)

M·ªôt m·∫©u truy·ªán nh·ªè cho th·∫•y s·ª©c m·∫°nh c·ªßa `sudo`, khi ta n√≥i m√† ƒë·ªëi ph∆∞∆°ng kh√¥ng nghe, th√™m `sudo` v√†o ƒë·∫ßu l√† m·ªçi th·ª© ƒë·ªÅu s·∫Ω ho·∫°t ƒë·ªông.

### sudo - SUperuser DO
Tr√™n c√°c h·ªá ƒëi·ªÅu h√†nh *NIX c√≥ chia ra nhi·ªÅu user ƒë·ªÉ nhi·ªÅu ng∆∞·ªùi  d√πng chung m·ªôt m√°y t√≠nh. Trong ƒë√≥, m·ªçi m√°y t√≠nh lu√¥n c√≥ user `root` - user c√≥ quy·ªÅn nƒÉng t·ªëi th∆∞·ª£ng, th∆∞·ªùng ƒë∆∞·ª£c g·ªçi l√† quy·ªÅn admin hay superuser, c√≥ th·ªÉ th·ª±c hi·ªán b·∫•t k·ª≥ thay ƒë·ªïi g√¨ tr√™n m√°y t√≠nh. Do c√≥ quy·ªÅn nƒÉng v√¥ h·∫°n nh∆∞ v·∫≠y, n√™n khi th·ª±c hi·ªán vi·ªác g√¨ c≈©ng ·∫©n ch·ª©a nguy hi·ªÉm, m·ªôt c√¢u l·ªánh g√µ nh·∫ßm c≈©ng c√≥ th·ªÉ ph√° hu·ª∑ h·ªá th·ªëng, v√† n·∫øu nh∆∞ ai c≈©ng l√† root th√¨ h·ªá th·ªëng s·∫Ω lo·∫°n, ng∆∞·ªùi d√πng kh√¥ng hi·ªÉu bi·∫øt c√≥ th·ªÉ c√†i ƒë·∫∑t c√°c lo·∫°i virus/malware l√™n m√°y t√≠nh (hi Windows).

ƒê·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅn n√†y, ng∆∞·ªùi ta s·∫£n xu·∫•t ra ph·∫ßn m·ªÅm t√™n "sudo", cho ph√©p c·∫•p quy·ªÅn cho c√°c user nh·∫•t ƒë·ªãnh. V·ªõi s·ª± t·ªìn t·∫°i c·ªßa sudo, ng∆∞·ªùi ta thay ƒë·ªïi c√°ch d√πng m√°y t√≠nh:
- t·∫•t c·∫£ m·ªçi ng∆∞·ªùi ƒë·ªÅu c√≥ t√†i kho·∫£n ri√™ng c·ªßa m√¨nh
- c·∫•p quy·ªÅn `root` cho m·ªôt s·ªë user c·ª• th·ªÉ
- user ƒë∆∞·ª£c c·∫•p quy·ªÅn c√≥ th·ªÉ ch·∫°y c√¢u l·ªánh nh∆∞ user root.

### Khi n√†o c·∫ßn quy·ªÅn root
M·ªói user tr√™n *NIX ƒë∆∞·ª£c c·∫•p m·ªôt th∆∞ m·ª•c g·ªçi l√† th∆∞ m·ª•c HOME. C√≥ th·ªÉ truy c·∫≠p th∆∞ m·ª•c n√†y b·∫±ng:

```bash
cd ~
```

hay
```bash
cd $HOME
```

Th∆∞ m·ª•c n√†y th∆∞·ªùng c√≥ ƒë∆∞·ªùng d·∫´n `/home/yourname/`.
v√† m·∫∑c ƒë·ªãnh thu·ªôc to√†n quy·ªÅn s·ª≠ d·ª•ng c·ªßa user <yourname>, th√≠ch t·∫°o/s·ª≠a/xo√° file n√†o th√¨ tu·ª≥ √Ω.

H·ªá th·ªëng c√≥ th∆∞ m·ª•c ƒë·∫∑c bi·ªát `/tmp`, ai c≈©ng ƒë·ªÅu c√≥ th·ªÉ ghi v√†o (nh∆∞ng ng∆∞·ªùi n√†y kh√¥ng th·ªÉ can thi·ªáp v√†o file/th∆∞ m·ª•c c·ªßa ng∆∞·ªùi kia) - v√† c√°c file trong n√†y s·∫Ω t·ª± b·ªã xo√° m·ªói khi m√°y t·∫Øt.

C√≤n l·∫°i, c√°c th∆∞ m·ª•c kh√°c tr√™n m√°y t√≠nh ch·ªâ c√≥ `root` m·ªõi c√≥ th·ªÉ thay ƒë·ªïi (/etc, /log, /var, /usr, /bin ...), khi s·ª≠ d·ª•ng c√°c ph·∫ßn m·ªÅm th·ª±c hi·ªán thay ƒë·ªïi ·∫£nh h∆∞·ªüng ƒë·∫øn c·∫£ h·ªá th·ªëng, v√≠ d·ª• d√πng `apt-get` ƒë·ªÉ c√†i package, l√Ω do ta c·∫ßn ch·∫°y sudo v√¨:
- apt-get s·∫Ω ghi file v√†o c√°c th∆∞ m·ª•c n√≥i tr√™n. V√≠ d·ª• khi c√†i package `nginx`, c√°c file sau s·∫Ω ƒë∆∞·ª£c t·∫°o ra:

```sh
$ dpkg -L nginx | grep nginx
/var/cache/nginx
/var/log/nginx
/usr/lib/nginx
/usr/lib/nginx/modules
/usr/share/doc/nginx
/usr/share/doc/nginx/CHANGES.ru.gz
/usr/share/doc/nginx/changelog.Debian.gz
/usr/share/doc/nginx/changelog.gz
/usr/share/doc/nginx/copyright
/usr/share/doc/nginx/README
/usr/share/man/man8/nginx.8.gz
/usr/share/lintian/overrides/nginx
/usr/share/nginx
/usr/share/nginx/html
/usr/share/nginx/html/index.html
/usr/share/nginx/html/50x.html
/usr/sbin/nginx-debug
/usr/sbin/nginx
/etc/init.d/nginx-debug
/etc/init.d/nginx
/etc/logrotate.d/nginx
/etc/nginx
/etc/nginx/koi-win
/etc/nginx/fastcgi_params
/etc/nginx/uwsgi_params
/etc/nginx/mime.types
/etc/nginx/koi-utf
/etc/nginx/nginx.conf
/etc/nginx/conf.d
/etc/nginx/conf.d/default.conf
/etc/nginx/scgi_params
/etc/nginx/win-utf
/etc/default/nginx-debug
/etc/default/nginx
/etc/nginx/modules
...
```

Ch·ªâ user `root` m·ªõi c√≥ quy·ªÅn ghi v√†o /etc/ /bin ... ƒë√≥ l√† l√Ω do c·∫ßn th√™m `sudo` khi ng∆∞·ªùi d√πng v·ªõi user c·ªßa h·ªç ch·∫°y c√¢u l·ªánh `apt-get`.

N·∫øu ta c·∫•u h√¨nh cho `apt-get` kh√¥ng ghi v√†o c√°c th∆∞ m·ª•c tr√™n, ta ho√†n to√†n c√≥ th·ªÉ ch·∫°y `apt-get` ƒë·ªÉ c√†i ƒë·∫∑t package tr√™n th∆∞ m·ª•c home c·ªßa m√¨nh. C√°c ch∆∞∆°ng tr√¨nh ƒë∆∞·ª£c c√†i xong s·∫Ω ch·ªâ m√¨nh m√¨nh d√πng ƒë∆∞·ª£c, do user kh√°c kh√¥ng truy c·∫≠p ƒë∆∞·ª£c v√†o c√°c file n√†y.

### sudo pip

Khi d√πng pip c√†i ipython (kh√¥ng d√πng virtualenv), ƒë√¢y l√† n∆°i ipython s·∫Ω ƒë∆∞·ª£c c√†i:

```
root@hvn:~# pip show ipython
Name: ipython
Version: 6.1.0
Summary: IPython: Productive Interactive Computing
Home-page: https://ipython.org
Author: The IPython Development Team
Author-email: ipython-dev@python.org
License: BSD
Location: /usr/local/lib/python3.5/dist-packages
Requires: prompt-toolkit, setuptools, pygments, simplegeneric, jedi, pexpect, traitlets, pickleshare, decorator
```

`/usr/local` l√† th∆∞ m·ª•c ch·ªâ `root` m·ªõi ƒë∆∞·ª£c quy·ªÅn ghi, v√¨ v·∫≠y b·∫°n kh√¥ng th·ªÉ ch·∫°y `pip install PACKAGE`, b·ªüi user th√¥ng th∆∞·ªùng kh√¥ng c√≥ quy·ªÅn (permission denied) ghi v√†o /usr

```sh
$ pip install phg
..,
PermissionError: [Errno 13] Permission denied: '/usr/local/lib/python3.5/dist-packages/phg-1.1.0.dist-info'
```

M√¥-tu√Ωp truy·ªÅn th·ªëng l·∫°i x·∫£y ra:
- "M√¨nh kh√¥ng c√†i ƒë∆∞·ª£c ..."
- "sudo pip ..."

C√°ch l√†m n√†y kh√¥ng sai, nh∆∞ng thi·∫øu hi·ªÉu bi·∫øt:
- n√≥ c√†i ƒë·∫∑t package l√™n th∆∞ m·ª•c h·ªá th·ªëng /usr/local/lib, khi c√≥ nhu c·∫ßu s·ª≠ d·ª•ng 2 phi√™n b·∫£n c·ªßa c√πng 1 ph·∫ßn m·ªÅm, ta kh√¥ng th·ªÉ g·ª° m·ªôt b·∫£n ƒëi v√† gi·ªØ l·∫°i b·∫£n kia (VD: django 1.7 v√† django 1.11)
- kh√¥ng ph·∫£i code n√†o c√†i t·ª´ pip c≈©ng an to√†n, khi ch·∫°y v·ªõi user root c√†i m·ªôt package ch·ª©a code ph√° ho·∫°i, n√≥ c√≥ th·ªÉ hu·ª∑ di·ªát c·∫£ h·ªá th·ªëng (v√¨ user root c√≥ quy·ªÅn l√†m m·ªçi th·ª©).

Gi·∫£i ph√°p l√† virtualenv!

## Virtualenv
virtualenv l√† m·ªôt ph·∫ßn m·ªÅm vi·∫øt b·∫±ng Python, gi√∫p t·∫°o ra c√°c "m√¥i tr∆∞·ªùng ·∫£o" ƒë·ªÉ t√°ch bi·ªát c√°c m√¥i tr∆∞·ªùng c·ªßa c√°c project kh√°c nhau.

M·ªói "m√¥i tr∆∞·ªùng ·∫£o" v·ªÅ b·∫£n ch·∫•t ch·ªâ l√† m·ªôt th∆∞ m·ª•c, v·ªõi m·ªôt v√†i thay ƒë·ªïi khi·∫øn cho khi ta d√πng pip ƒë·ªÉ c√†i package, c√°c package s·∫Ω ƒë∆∞·ª£c c√†i v√†o th∆∞ m·ª•c n√†y. ƒêi·ªÅu n√†y gi·∫£i quy·∫øt c√°c v·∫•n ƒë·ªÅ n√≥i tr√™n:
- t√°ch bi·ªát c√°c m√¥i tr∆∞·ªùng gi·ªØa c√°c project, 2 project c√≥ th·ªÉ d√πng 2 phi√™n b·∫£n kh√°c nhau c·ªßa c√πng 1 ph·∫ßn m·ªÅm.
- ng∆∞·ªùi d√πng c√≥ th·ªÉ t·∫°o m√¥i tr∆∞·ªùng ·∫£o trong th∆∞ m·ª•c $HOME c·ªßa m√¨nh, kh√¥ng c·∫ßn ch·∫°y sudo - kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn h·ªá th·ªëng.

virtualenv ho·∫°t ƒë·ªông ƒë∆∞·ª£c l√† nh·ªù v√†o c√°ch m√† Python th·ª±c hi·ªán import. [Lu·∫≠t import c·ªßa Python](https://docs.python.org/3/tutorial/modules.html#the-module-search-path), khi ta `import spam`:

- T√¨m c√°c builtin module xem c√≥ c√°i n√†o t√™n l√† spam kh√¥ng. Danh s√°ch c√°c builtin module ƒë∆∞·ª£c ch·ª©a trong sys:

```sh
 python -c 'import sys; print(sys.builtin_module_names)'
('__builtin__', '__main__', '_ast', '_bisect', '_codecs', '_collections', '_functools', '_heapq', '_io', '_locale', '_md5', '_random', '_sha', '_sha256', '_sha512', '_socket', '_sre', '_struct', '_symtable', '_warnings', '_weakref', 'array', 'binascii', 'cPickle', 'cStringIO', 'cmath', 'datetime', 'errno', 'exceptions', 'fcntl', 'gc', 'grp', 'imp', 'itertools', 'marshal', 'math', 'operator', 'posix', 'pwd', 'select', 'signal', 'spwd', 'strop', 'sys', 'syslog', 'thread', 'time', 'unicodedata', 'xxsubtype', 'zipimport', 'zlib')
```

- N·∫øu kh√¥ng th·∫•y, t√¨m l·∫ßn l∆∞·ª£t trong c√°c th∆∞ m·ª•c ch·ª©a trong list : `sys.path`, cho ƒë·∫øn khi t√¨m th·∫•y file spam.py.
- N·∫øu v·∫´n kh√¥ng th·∫•y, raise Exception `ImportError`.

Khi ta b·∫≠t (activate) m·ªôt virtualenv l√™n (source), th·ª±c t·∫ø ta thay ƒë·ªïi sys.path, nh√©t ƒë∆∞·ªùng d·∫´n ƒë·∫øn "m√¥i tr∆∞·ªùng ·∫£o" hi·ªán t·∫°i l√™n ƒë·∫ßu sys.path, v√¨ v·∫≠y khi th·ª±c hi·ªán import, Python s·∫Ω t√¨m trong "m√¥i tr∆∞·ªùng ·∫£o" tr∆∞·ªõc.

ƒê·ªçc k·ªπ nh·ªØng d√≤ng sau ƒë·ªÉ th·∫•y s·ª± ·∫£nh h∆∞·ªüng c·ªßa virtualenv v·ªõi Python sys.path,
khi b·∫≠t virtualenv, ƒë∆∞·ªùng d·∫´n t·ªõi virtualenv s·∫Ω xu·∫•t hi·ªán trong sys.path,
t·ª©c module / code n√†o n·∫±m trong th∆∞ m·ª•c
`/home/hvn/myvenv/lib/python3.6/site-packages`
ƒë·ªÅu c√≥ th·ªÉ ƒë∆∞·ª£c import.

```sh
$ python3 -m venv myvenv
$ source myvenv/bin/activate
(myvenv) $ python3 -c 'import sys; print(sys.path)'
['', '/usr/lib/python36.zip', '/usr/lib/python3.6', '/usr/lib/python3.6/lib-dynload', '/home/hvn/myvenv/lib/python3.6/site-packages']
(myvenv) $ deactivate
$ python3 -c 'import sys; print(sys.path)'
['', '/usr/lib/python36.zip', '/usr/lib/python3.6', '/usr/lib/python3.6/lib-dynload', '/usr/local/lib/python3.6/dist-packages', '/usr/lib/python3/dist-packages']
```

V·ªõi virtualenv, ta s·∫Ω kh√¥ng bao gi·ªù ph·∫£i `sudo pip` n·ªØa, m·ªói project s·∫Ω c√≥ m·ªôt m√¥i tr∆∞·ªùng ri√™ng bi·ªát, kh√¥ng ai ·∫£nh h∆∞·ªüng t·ªõi ai. V√† ch·ªâ g√µ `sudo pip` khi c·∫ßn thay ƒë·ªïi 1 package tr√™n to√†n h·ªá th·ªëng.

### S·ª≠ d·ª•ng pip trong venv <a name="venv"></a>

Cho python3.6 tr·ªü l√™n, v√≠ d·ª• tr√™n Ubuntu 18.04, xem [t√†i
li·ªáu](https://docs.python.org/3/tutorial/venv.html)
cho l·ªánh d√πng tr√™n Windows.

```sh
$ python3 -m venv myvenv
$ source myvenv/bin/activate
(myvenv) $ python3 -m pip install django
Collecting django
  Cache entry deserialization failed, entry ignored
  Downloading https://files.pythonhosted.org/packages/5c/63/6d7efecbf3f06db8c6577950a24a191e55cadf7cda4d7fe6976206c886dd/Django-3.0.7-py3-none-any.whl (7.5MB)
    100% |‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 7.5MB 206kB/s
Collecting pytz (from django)
  Using cached https://files.pythonhosted.org/packages/4f/a4/879454d49688e2fad93e59d7d4efda580b783c745fd2ec2a3adf87b0808d/pytz-2020.1-py2.py3-none-any.whl
Collecting sqlparse>=0.2.2 (from django)
  Using cached https://files.pythonhosted.org/packages/85/ee/6e821932f413a5c4b76be9c5936e313e4fc626b33f16e027866e1d60f588/sqlparse-0.3.1-py2.py3-none-any.whl
Collecting asgiref~=3.2 (from django)
  Cache entry deserialization failed, entry ignored
  Downloading https://files.pythonhosted.org/packages/68/00/25013f7310a56d17e1ab6fd885d5c1f216b7123b550d295c93f8e29d372a/asgiref-3.2.7-py2.py3-none-any.whl
Installing collected packages: pytz, sqlparse, asgiref, django
Successfully installed asgiref-3.2.7 django-3.0.7 pytz-2020.1 sqlparse-0.3.1
(myvenv) $ python
Python 3.6.9 (default, Apr 18 2020, 01:56:04)
[GCC 8.4.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import django
>>> django.__version__
'3.0.7'
>>> quit()

$ python3 -m pip freeze
asgiref==3.2.7
Django==3.0.7
pkg-resources==0.0.0
pyfml==0.0.0
pytz==2020.1
sqlparse==0.3.1
```

## K·∫øt lu·∫≠n
`sudo` l√† s·ª©c m·∫°nh, ƒë·ª´ng ch·ªâ v√¨ qu√° m·∫°nh m√† th√≠ch l√†m g√¨ c≈©ng ƒë∆∞·ª£c üôÑ
